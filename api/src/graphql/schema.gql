type User @isAuthenticated {
	uid: ID!
    username: String!
	firstname: String!
	lastname: String!
	email: String!
	passsword: String!
	birthdate: String!
	gender: String
	images: [Image] @relation(name: "HAS_IMG", direction: "OUT")
	avatar: String! @cypher(statement: "MATCH (this)-[r:HAS_IMG]->(i:Image) RETURN collect(i)[0].url")
	bio: String
	tags: [Tag] @relation(name: "HAS_TAG", direction: "OUT")
	elo: Int!
	prefAgeMin: Int
	prefAgeMax: Int
	prefOrientation: String
	prefDistance: Int
	confirmToken: String!
	resetToken: String!
	likesCount: Int @cypher(statement: "MATCH (User)-[r:LIKED]->(this) RETURN COUNT(r)")
	likedUsers: [User] @relation(name: "LIKED", direction: "OUT")
	likedByUsers: [User] @relation(name: "LIKED", direction: "IN")
	visitedUsers: [User] @relation(name: "VISITED", direction: "OUT")
	visitedByUsers: [User] @relation(name: "VISITED", direction: "IN")
	conversations: [Conversation] @relation(name: "HAS_CONV", direction: "OUT")
}

type Image @isAuthenticated {
	uid: ID!
	url: String!
}

type Tag @isAuthenticated {
	uid: ID!
	name: String!
}

type Conversation @isAuthenticated {
    uid: ID!
    lastMessage: Message @cypher(statement: "MATCH (this)-[:HAS_MSG]-(msgs:Message) RETURN msgs ORDER BY msgs.uid DESC LIMIT 1")
    messages: [Message] @relation(name: "HAS_MSG", direction: "OUT")
    members: [User] @relation(name: "HAS_CONV", direction: "IN")
}

type Message @isAuthenticated {
    uid: ID!
    author: User @relation(name: "AUTHORED", direction: "IN")
    content: String!
}

type Blocked @isAuthenticated @relation(name: "BLOCKED") {
    uid: ID!
    from: User!
    to: User!
    at: String!
}

type Query {
    me: User @cypher(statement: "MATCH (user:User {uid: $cypherParams.currentUserUid}) RETURN user")
}

type Mutation {
    signup (firstname: String!, lastname: String!, username: String!, email: String!, password: String!): String
    login(username: String!, password: String!): String
    emailVerif(confirmToken: String!): String
    sendPwdReset(email: String!): String
    resetPassword(password: String!, resetToken: String!): String
    visitProfile(uid: ID!): User @cypher(statement: "MATCH (me:User {uid: $cypherParams.currentUserUid}), (target:User {uid: $uid}) WHERE NOT me = target MERGE (me)-[:VISITED]->(target) RETURN target")
    reportUser(uid: ID!): User
}
